# -*- coding: utf-8 -*-
"""Traffic sign testing.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/17n4P8azm1SO17Bwv9DFqNcleM9AdbZ87
"""

from google.colab import files
my_file=files.upload()

import os
import pandas as pd
cred = pd.read_json("kaggle.json",lines=True)
os.environ['KAGGLE_USERNAME'] = cred.iloc[0][0]
os.environ['KAGGLE_KEY'] = cred.iloc[0][1]

from google.colab import drive
drive.mount('/content/drive')

!kaggle datasets download -d srthk5/traffic-set

# Commented out IPython magic to ensure Python compatibility.
# %reload_ext autoreload
# %autoreload 2
# %matplotlib inline

from fastai.vision import *
from fastai.metrics import error_rate

!unzip "*.zip"

my_dir= "/content/drive/My Drive/traffic sign"

predictor = load_learner(my_dir)

def my_predictor(im):
  test_img =open_image(im)
  pred_class,pred_idx,outputs=predictor.predict(test_img)
  return pred_class

all_test_images=os.listdir("/content/545505_1000084_bundle_archive/test_data")

idx=1
print(my_predictor("545505_1000084_bundle_archive/test_data/"+all_test_images[idx]))
img = open_image("545505_1000084_bundle_archive/test_data/"+all_test_images[idx])
img.show()

// video

import cv2
test_files=os.listdir("545505_1000084_bundle_archive/test_data/")
os.makedirs("test_result",exist_ok=True)
i=0
for test_file in test_files:
  img=cv2.imread("545505_1000084_bundle_archive/test_data/"+test_file)
  cv2.imwrite("temp.jpg",img)
  ans_text=my_predictor("temp.jpg")
  font = cv2.FONT_HERSHEY_PLAIN
  i+=1
  org = (0,50) 
  fontScale = 1
  color = (250, 0, 0) 
  thickness =2
  img = cv2.putText(img, str(ans_text), org, font,fontScale, color, thickness, cv2.LINE_AA) 
  cv2.imwrite("test_result/"+str(i)+".jpg", img)

# Commented out IPython magic to ensure Python compatibility.
# %cd "test_result"
!ffmpeg -framerate 1 -pattern_type glob -i '*.jpg' \-c:v libx264 -r 1 -pix_fmt yuv420p ../my_final_output.mp4
# %cd ..

!pip install -U kora
from kora.drive import upload_public

url = upload_public('my_final_output.mp4')

from IPython.display import HTML
HTML(f"""<video src={url} width=500 controls/>""")

url

