# -*- coding: utf-8 -*-
"""Traffic sign training.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1E923kgqvvteT80x1VhaRVMOKsuRYgFAc
"""

from google.colab import files
my_file=files.upload()

import os
import pandas as pd
cred = pd.read_json("kaggle.json",lines=True)
os.environ['KAGGLE_USERNAME'] = cred.iloc[0][0]
os.environ['KAGGLE_KEY'] = cred.iloc[0][1]

!kaggle datasets download -d srthk5/traffic-set

!unzip "*.zip"

# Commented out IPython magic to ensure Python compatibility.
# %reload_ext autoreload
# %autoreload 2
# %matplotlib inline
from fastai.vision import *
from fastai.metrics import error_rate
import warnings
warnings.filterwarnings("ignore", category=FutureWarning)

bs=64

path=""
tfms = get_transforms(do_flip=True)
data = ImageDataBunch.from_folder( Path(""), valid_pct=0.2, bs=64, size=224, ds_tfms=get_transforms())

data.show_batch(rows=3, figsize=(5,5))

learn = cnn_learner(data, models.resnet50, metrics=accuracy)

learn.fit_one_cycle(4)

from google.colab import drive
drive.mount("/content/drive")

os.makedirs('/content/drive/My Drive/project 1/Traffic_signs',exist_ok=True)

my_dir="/content/drive/My Drive/project 1/Traffic_signs"

learn.save(my_dir+"/Stage-1")

learn.fit_one_cycle(2)

learn.load(my_dir+"/Stage-1")

learn.load("/content/drive/My Drive/project 1/Traffic_signs/Stage-1")

learn.export(my_dir+"/export.pkl")

learn.load('/content/drive/My Drive/project 1/Traffic_signs/Stage-1.pth')

interp = ClassificationInterpretation.from_learner(learn)
losses,idxs=interp.top_losses()
len(data.valid_ds)==len(losses)==len(idxs)

interp.plot_top_losses(9, figsize=(15,11))

interp.plot_confusion_matrix(figsize=(12,12), dpi=60)

